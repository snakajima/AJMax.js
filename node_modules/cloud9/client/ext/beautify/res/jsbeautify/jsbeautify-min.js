define(function(a,b,c){b.js_beautify=function(a,b){function T(){x=0;if(p>=G)return["","TK_EOF"];v=!1;var a=c.charAt(p);p+=1;var b=F&&P(j.mode);if(b){var e=0;while(S(a,m)){a==="\n"?(H(),d.push("\n"),w=!0,e=0):a==="\t"?e+=4:a!=="\r"&&(e+=1);if(p>=G)return["","TK_EOF"];a=c.charAt(p),p+=1}j.indentation_baseline===-1&&(j.indentation_baseline=e);if(w){var h;for(h=0;h<j.indentation_level+1;h+=1)d.push(l);if(j.indentation_baseline!==-1)for(h=0;h<e-j.indentation_baseline;h++)d.push(" ")}}else{while(S(a,m)){a==="\n"&&(x+=C?x<=C?1:0:1);if(p>=G)return["","TK_EOF"];a=c.charAt(p),p+=1}if(B&&x>1)for(h=0;h<x;h+=1)J(h===0),w=!0;v=x>0}if(S(a,n)){if(p<G)while(S(c.charAt(p),n)){a+=c.charAt(p),p+=1;if(p===G)break}if(p!==G&&a.match(/^[0-9]+[Ee]$/)&&(c.charAt(p)==="-"||c.charAt(p)==="+")){var i=c.charAt(p);p+=1;var k=T(p);a+=i+k[0];return[a,"TK_WORD"]}if(a==="in")return[a,"TK_OPERATOR"];v&&f!=="TK_OPERATOR"&&f!=="TK_EQUALS"&&!j.if_line&&(B||g!=="var")&&J();return[a,"TK_WORD"]}if(a==="("||a==="[")return[a,"TK_START_EXPR"];if(a===")"||a==="]")return[a,"TK_END_EXPR"];if(a==="{")return[a,"TK_START_BLOCK"];if(a==="}")return[a,"TK_END_BLOCK"];if(a===";")return[a,"TK_SEMICOLON"];if(a==="/"){var q="",s=!0;if(c.charAt(p)==="*"){p+=1;if(p<G)while((c.charAt(p)!=="*"||!c.charAt(p+1)||c.charAt(p+1)!=="/")&&p<G){a=c.charAt(p),q+=a;if(a==="\r"||a==="\n")s=!1;p+=1;if(p>=G)break}p+=2;return s?["/*"+q+"*/","TK_INLINE_COMMENT"]:["/*"+q+"*/","TK_BLOCK_COMMENT"]}if(c.charAt(p)==="/"){q=a;while(c.charAt(p)!=="\r"&&c.charAt(p)!=="\n"){q+=c.charAt(p),p+=1;if(p>=G)break}p+=1,v&&J();return[q,"TK_COMMENT"]}}if(a==="'"||a==='"'||a==="/"&&(f==="TK_WORD"&&S(g,["return","do"])||f==="TK_COMMENT"||f==="TK_START_EXPR"||f==="TK_START_BLOCK"||f==="TK_END_BLOCK"||f==="TK_OPERATOR"||f==="TK_EQUALS"||f==="TK_EOF"||f==="TK_SEMICOLON")){var t=a,u=!1,y=a;if(p<G)if(t==="/"){var z=!1;while(u||z||c.charAt(p)!==t){y+=c.charAt(p),u?u=!1:(u=c.charAt(p)==="\\",c.charAt(p)==="["?z=!0:c.charAt(p)==="]"&&(z=!1)),p+=1;if(p>=G)return[y,"TK_STRING"]}}else while(u||c.charAt(p)!==t){y+=c.charAt(p),u?u=!1:u=c.charAt(p)==="\\",p+=1;if(p>=G)return[y,"TK_STRING"]}p+=1,y+=t;if(t==="/")while(p<G&&S(c.charAt(p),n))y+=c.charAt(p),p+=1;return[y,"TK_STRING"]}if(a==="#"){if(d.length===0&&c.charAt(p)==="!"){y=a;while(p<G&&a!="\n")a=c.charAt(p),y+=a,p+=1;d.push(I(y)+"\n"),J();return T()}var A="#";if(p<G&&S(c.charAt(p),r)){do a=c.charAt(p),A+=a,p+=1;while(p<G&&a!=="#"&&a!=="=");a!=="#"&&(c.charAt(p)==="["&&c.charAt(p+1)==="]"?(A+="[]",p+=2):c.charAt(p)==="{"&&c.charAt(p+1)==="}"&&(A+="{}",p+=2));return[A,"TK_WORD"]}}if(a==="<"&&c.substring(p-1,p+3)==="<!--"){p+=3,j.in_html_comment=!0;return["<!--","TK_COMMENT"]}if(a==="-"&&j.in_html_comment&&c.substring(p-1,p+2)==="-->"){j.in_html_comment=!1,p+=2,v&&J();return["-->","TK_COMMENT"]}if(S(a,o)){while(p<G&&S(a+c.charAt(p),o)){a+=c.charAt(p),p+=1;if(p>=G)break}return a==="="?[a,"TK_EQUALS"]:[a,"TK_OPERATOR"]}return[a,"TK_UNKNOWN"]}function S(a,b){for(var c=0;c<b.length;c+=1)if(b[c]===a)return!0;return!1}function R(){u=j.mode==="DO_BLOCK",k.length>0&&(j=k.pop())}function Q(a){return a==="[EXPRESSION]"||a==="[INDENTED-EXPRESSION]"||a==="(EXPRESSION)"}function P(a){return a==="[EXPRESSION]"||a==="[INDENTED-EXPRESSION]"}function O(a){j&&k.push(j),j={previous_mode:j?j.mode:"BLOCK",mode:a,var_line:!1,var_line_tainted:!1,var_line_reindented:!1,in_html_comment:!1,if_line:!1,in_case:!1,eat_next_space:!1,indentation_baseline:-1,indentation_level:j?j.indentation_level+(j.var_line&&j.var_line_reindented?1:0):D,ternary_depth:0}}function N(){d.length&&d[d.length-1]===l&&d.pop()}function M(){j.indentation_level+=1}function L(){w=!1,j.eat_next_space=!1,d.push(e)}function K(){if(j.eat_next_space)j.eat_next_space=!1;else{var a=" ";d.length&&(a=d[d.length-1]),a!==" "&&a!=="\n"&&a!==l&&d.push(" ")}}function J(a){j.eat_next_space=!1;if(!F||!P(j.mode)){a=typeof a=="undefined"?!0:a,j.if_line=!1,H();if(!d.length)return;if(d[d.length-1]!=="\n"||!a)w=!0,d.push("\n");for(var b=0;b<j.indentation_level;b+=1)d.push(l);j.var_line&&j.var_line_reindented&&(A===" "?d.push("    "):d.push(l))}}function I(a){return a.replace(/^\s\s*|\s\s*$/,"")}function H(a){a=typeof a=="undefined"?!1:a;while(d.length&&(d[d.length-1]===" "||d[d.length-1]===l||a&&(d[d.length-1]==="\n"||d[d.length-1]==="\r")))d.pop()}var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;b=b?b:{};var y;b.space_after_anon_function!==undefined&&b.jslint_happy===undefined&&(b.jslint_happy=b.space_after_anon_function),b.braces_on_own_line!==undefined&&(y=b.braces_on_own_line?"expand":"collapse"),y=b.brace_style?b.brace_style:y?y:"collapse";var z=b.indent_size?b.indent_size:4,A=b.indent_char?b.indent_char:" ",B=typeof b.preserve_newlines=="undefined"?!0:b.preserve_newlines,C=typeof b.max_preserve_newlines=="undefined"?!1:b.max_preserve_newlines,D=b.indent_level?b.indent_level:0,E=b.jslint_happy==="undefined"?!1:b.jslint_happy,F=typeof b.keep_array_indentation=="undefined"?!1:b.keep_array_indentation;w=!1;var G=a.length;l="";while(z>0)l+=A,z-=1;c=a,i="",f="TK_START_EXPR",g="",h="",d=[],u=!1,m="\n\r\t ".split(""),n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_$".split(""),r="0123456789".split(""),o="+ - * / % & ++ -- = += -= *= /= %= == === != !== > < >= <= >> << >>> >>>= >>= <<= && &= | || ! !! , : ? ^ ^= |= ::".split(" "),q="continue,try,throw,return,var,if,switch,case,default,for,while,break,function".split(","),k=[],O("BLOCK"),p=0;for(;;){var U=T(p);e=U[0],t=U[1];if(t==="TK_EOF")break;switch(t){case"TK_START_EXPR":if(e==="["){if(f==="TK_WORD"||g===")"){S(g,q)&&K(),O("(EXPRESSION)"),L();break}j.mode==="[EXPRESSION]"||j.mode==="[INDENTED-EXPRESSION]"?h==="]"&&g===","?(j.mode==="[EXPRESSION]"&&(j.mode="[INDENTED-EXPRESSION]",F||M()),O("[EXPRESSION]"),F||J()):g==="["?(j.mode==="[EXPRESSION]"&&(j.mode="[INDENTED-EXPRESSION]",F||M()),O("[EXPRESSION]"),F||J()):O("[EXPRESSION]"):O("[EXPRESSION]")}else O("(EXPRESSION)");g===";"||f==="TK_START_BLOCK"?J():f!=="TK_END_EXPR"&&f!=="TK_START_EXPR"&&f!=="TK_END_BLOCK"&&g!=="."&&(f!=="TK_WORD"&&f!=="TK_OPERATOR"?K():i==="function"||i==="typeof"?E&&K():(S(g,q)||g==="catch")&&K()),L();break;case"TK_END_EXPR":if(e==="]")if(F){if(g==="}"){N(),L(),R();break}}else if(j.mode==="[INDENTED-EXPRESSION]"&&g==="]"){R(),J(),L();break}R(),L();break;case"TK_START_BLOCK":i==="do"?O("DO_BLOCK"):O("BLOCK"),y=="expand"?(f!=="TK_OPERATOR"&&(g==="return"||g==="="?K():J(!0)),L(),M()):(f!=="TK_OPERATOR"&&f!=="TK_START_EXPR"?f==="TK_START_BLOCK"?J():K():P(j.previous_mode)&&g===","&&(h==="}"?K():J()),M(),L());break;case"TK_END_BLOCK":R(),y=="expand"?(g!=="{"&&J(),L()):(f==="TK_START_BLOCK"?w?N():H():P(j.mode)&&F?(F=!1,J(),F=!0):J(),L());break;case"TK_WORD":if(u){K(),L(),K(),u=!1;break}if(e==="function"){j.var_line&&(j.var_line_reindented=!0);if((w||g===";")&&g!=="{"){x=w?x:0,B||(x=1);for(var V=0;V<2-x;V++)J(!1)}}if(e==="case"||e==="default"){g===":"?N():(j.indentation_level--,J(),j.indentation_level++),L(),j.in_case=!0;break}s="NONE",f==="TK_END_BLOCK"?S(e.toLowerCase(),["else","catch","finally"])?y=="expand"||y=="end-expand"?s="NEWLINE":(s="SPACE",K()):s="NEWLINE":f!=="TK_SEMICOLON"||j.mode!=="BLOCK"&&j.mode!=="DO_BLOCK"?f==="TK_SEMICOLON"&&Q(j.mode)?s="SPACE":f==="TK_STRING"?s="NEWLINE":f==="TK_WORD"?(g==="else"&&H(!0),s="SPACE"):f==="TK_START_BLOCK"?s="NEWLINE":f==="TK_END_EXPR"&&(K(),s="NEWLINE"):s="NEWLINE",S(e,q)&&g!==")"&&(g=="else"?s="SPACE":s="NEWLINE"),j.if_line&&f==="TK_END_EXPR"&&(j.if_line=!1);if(S(e.toLowerCase(),["else","catch","finally"]))f!=="TK_END_BLOCK"||y=="expand"||y=="end-expand"?J():(H(!0),K());else if(s==="NEWLINE"){if(f!=="TK_START_EXPR"&&g!=="="&&g!==","||e!=="function")e==="function"&&g=="new"?K():g==="return"||g==="throw"?K():f!=="TK_END_EXPR"?(f!=="TK_START_EXPR"||e!=="var")&&g!==":"&&(e==="if"&&i==="else"&&g!=="{"?K():(j.var_line=!1,j.var_line_reindented=!1,J())):S(e,q)&&g!=")"&&(j.var_line=!1,j.var_line_reindented=!1,J())}else P(j.mode)&&g===","&&h==="}"?J():s==="SPACE"&&K();L(),i=e,e==="var"&&(j.var_line=!0,j.var_line_reindented=!1,j.var_line_tainted=!1),e==="if"&&(j.if_line=!0),e==="else"&&(j.if_line=!1);break;case"TK_SEMICOLON":L(),j.var_line=!1,j.var_line_reindented=!1,j.mode=="OBJECT"&&(j.mode="BLOCK");break;case"TK_STRING":f==="TK_START_BLOCK"||f==="TK_END_BLOCK"||f==="TK_SEMICOLON"?J():f==="TK_WORD"&&K(),L();break;case"TK_EQUALS":j.var_line&&(j.var_line_tainted=!0),K(),L(),K();break;case"TK_OPERATOR":var W=!0,X=!0;j.var_line&&e===","&&Q(j.mode)&&(j.var_line_tainted=!1);if(j.var_line&&e===","){if(j.var_line_tainted){L(),j.var_line_reindented=!0,j.var_line_tainted=!1,J();break}j.var_line_tainted=!1}if(g==="return"||g==="throw"){K(),L();break}if(e===":"&&j.in_case){L(),J(),j.in_case=!1;break}if(e==="::"){L();break}if(e===","){j.var_line?j.var_line_tainted?(L(),J(),j.var_line_tainted=!1):(L(),K()):f==="TK_END_BLOCK"&&j.mode!=="(EXPRESSION)"?(L(),j.mode==="OBJECT"&&g==="}"?J():K()):j.mode==="OBJECT"?(L(),J()):(L(),K());break}S(e,["--","++","!"])||S(e,["-","+"])&&(S(f,["TK_START_BLOCK","TK_START_EXPR","TK_EQUALS","TK_OPERATOR"])||S(g,q))?(W=!1,X=!1,g===";"&&Q(j.mode)&&(W=!0),f==="TK_WORD"&&S(g,q)&&(W=!0),j.mode==="BLOCK"&&(g==="{"||g===";")&&J()):e==="."?W=!1:e===":"?j.ternary_depth==0?(j.mode="OBJECT",W=!1):j.ternary_depth-=1:e==="?"&&(j.ternary_depth+=1),W&&K(),L(),X&&K(),e!=="!";break;case"TK_BLOCK_COMMENT":var Y=e.split(/\x0a|\x0d\x0a/);if(/^\/\*\*/.test(e)){J(),d.push(Y[0]);for(V=1;V<Y.length;V++)J(),d.push(" "),d.push(I(Y[V]))}else{Y.length>1?(J(),H()):K();for(V=0;V<Y.length;V++)d.push(Y[V]),d.push("\n")}J();break;case"TK_INLINE_COMMENT":K(),L(),Q(j.mode)?K():J();break;case"TK_COMMENT":v?J():K(),L(),J();break;case"TK_UNKNOWN":(g==="return"||g==="throw")&&K(),L()}h=g,f=t,g=e}return d.join("").replace(/[\n ]+$/,"")}})